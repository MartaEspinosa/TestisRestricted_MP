---
title: "Brain-restricted microproteins | RNASeq"
author: "Marta Espinosa"
date: "2024-05-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(purrr)
library(ggvenn)
library(ggpubr)
library(ggside)
library(bioseq)
library(rcartocolor)
library(ggbeeswarm)
library(ggrepel)

plots_wd = "/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q2_TestisRestricted/human/plots/brain"
save_wd = "/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q2_TestisRestricted/human/brain"

annot = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/human/newReference_Resconstructed/transID_geneID_isoforms_selected.1to1.csv")
```


## Human Data | RNASeq

### Load Table of Counts (input data)

Obtained using STAR to align and featureCounts to quantify.

```{r length, echo=FALSE}
## Load counts data
# raw_counts = read.table("/users/genomics/saraa/projectTestis/featureCounts/results_geneID/featureCounts_geneID.txt header=TRUE)
toc_TPMs = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/human/featureCounts_gffcompare/table_of_counts_TPMs_withLength.csv", header=TRUE)

## For novels, remove those shorter than 300 pb
toc_TPMs = toc_TPMs %>%
  filter(!(startsWith(gene_id, "TCONS") & Length < 300))
names(toc_TPMs)[1] = "transcript_id"

toc_TPMs = merge(toc_TPMs, annot, by="transcript_id", all.x=T)
toc_TPMs = toc_TPMs %>% unique()

ggplot(toc_TPMs %>% subset(gene_type == "lncRNA" | gene_type == "processed_pseudogene" | gene_type == "protein_coding" | gene_type == "novel"), aes(x=Length, fill=gene_type)) +
  geom_density(alpha=0.6) +
  geom_vline(xintercept = 300) +
  scale_x_continuous(trans="log10") +
    labs(x="Length (nt)",
       fill="Biotype",
       title="Gene length distribution per biotype") +
  scale_fill_manual(values=c("protein_coding"="#ead890",
                         "lncRNA" = "#cd4f38",
                         "processed_pseudogene" = "#e48c2a",
                                               "novel" = "#637c68")) +
  theme_classic() +
  theme(legend.position = "top")
ggsave(file.path(plots_wd,"PNG/length_density.png"), height=4.45, width=5.30)
ggsave(file.path(plots_wd,"PDF/length_density.pdf"), height=4.45, width=5.30)

toc_TPMs = toc_TPMs %>% select(-Length)

dim(toc_TPMs)
toc_TPMs %>% head
```

### TPM normalization of raw counts

The expression counts data is normalized in transcript per million (TPM).

```{r TPM, echo=F}
# counts = raw_counts_Symb[,c(1,6:ncol(raw_counts_Symb))]
# toc_TPMs = counts
# geneLengths = counts$Length
# 
# rpk = apply(counts[,3:11],2, function(x) x/(geneLengths/10^3))
# 
# ## normalize by the sample using rpk values
# toc_TPMs[,3:11] = apply(rpk,2,function(x) x/sum(as.numeric(x), na.rm=TRUE)*10^6)
# write.csv(toc_TPMs, file.path(save_wd,"TPMs_complete.csv"), row.names = F)
## CheckPoint. the sum of each column after rpm normalization equals to 10^6
# colSums(toc_TPMs[,3:11], na.rm=TRUE)
# dim(toc_TPMs[,3:11])
```

```{r TPM_distribution, echo=F}
# toc_TPMs_long = toc_TPMs %>% pivot_longer(cols=-c(gene_id, gene_name, Length, gene_type), names_to = "sample values_to = "TPM")
## get patient number
toc_TPMs = toc_TPMs %>% select(-transcript_type)
toc_TPMs_long = toc_TPMs %>% pivot_longer(cols=-c(gene_id, gene_name, transcript_id, gene_type, chr, gene_type), names_to = "sample", values_to = "TPM")

toc_TPMs_long$patient = sapply(strsplit(toc_TPMs_long$sample, "_"), function(x) x[length(x)])
toc_TPMs_long$patient = paste0("Patient",toc_TPMs_long$patient)
## get tissue data
toc_TPMs_long$tissue = sapply(strsplit(toc_TPMs_long$sample, "_"), function(x) x[2])
## log2TPM
toc_TPMs_long$log2TPM = log2(toc_TPMs_long$TPM)


#-------------- log2TPM boxplots per tissue --------------#
ggplot(toc_TPMs_long, aes(x=patient, y=log2TPM, fill=tissue))+
  geom_boxplot() +
  labs(x="Patient",
       fill="Tissue",
       title="Gene expression distribution per tissue") +
  scale_fill_manual(values=c("liver"="#ABCD72",
                             "brain" = "#8C57A2",
                             "testis" = "#82581F")) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90),
        legend.position = "none") +
  facet_wrap(~ tissue)
ggsave(file.path(plots_wd,"PNG/TPM_boxplot_tissue.png"), height=4.45, width=4.30)
ggsave(file.path(plots_wd,"PDF/TPM_boxplot_tissue.pdf"), height=4.45, width=4.30)

#-------------- log2TPM boxplots per genetype --------------#
ggplot(toc_TPMs_long %>% subset(gene_type == "lncRNA" | gene_type == "processed_pseudogene" | gene_type == "protein_coding" | gene_type == "novel"), aes(x=patient, y=log2TPM, fill=gene_type))+
  geom_boxplot() +
  labs(x="Patient",
       fill="Biotype",
       title="Gene expression distribution per biotype") +
  scale_fill_manual(values=c("protein_coding"="#ead890",
                         "lncRNA" = "#cd4f38",
                         "processed_pseudogene" = "#e48c2a",
                                               "novel" = "#637c68")) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90),
        legend.position = "none") +
  facet_wrap(~ gene_type, ncol=4)
ggsave(file.path(plots_wd,"PNG/TPM_boxplot_biotype.png"), height=4.45, width=4.30)
ggsave(file.path(plots_wd,"PDF/TPM_boxplot_biotype.pdf"), height=4.45, width=4.30)


```

### brain-Expressed | RNASeq

* > 1 TPM in at least 1 sample

```{r brainExpressed, echo=F}
toc_TPMs_subset = toc_TPMs %>% select(-c(chr)) %>% subset(gene_type == "lncRNA" | gene_type == "processed_pseudogene" | gene_type == "protein_coding" | gene_type == "novel") %>% unique()

#------------------ BRAIN ------------------#
## they should be brain-expressed in at least 2 patients
brainexpr = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(2:4)] > 1) >= 1, ]
## merge with all info
brainexpr_full = merge(brainexpr, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
brainexpr_full = brainexpr_full %>% unique()

write.csv(brainexpr_full, file.path(save_wd,"brainExpressed.csv"), row.names = F)


#------------------ LIVER ------------------#
## they should be liver-expressed in at least 2 patients
liverexpr = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(5:7)] > 1) >= 1, ]
## merge with all info
liverexpr_full = merge(liverexpr, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
liverexpr_full = liverexpr_full %>% unique()

write.csv(liverexpr_full, file.path(save_wd,"liverExpressed.csv"), row.names = F)

#------------------ TESTIS ------------------#
## they should be testis-expressed in at least 2 patients
testisexpr = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(8:10)] > 1) >= 1, ]

## merge with all info
testisexpr_full = merge(testisexpr, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
testisexpr_full = testisexpr_full %>% unique()

write.csv(testisexpr_full, file.path(save_wd,"testisExpressed.csv"), row.names = F)

print("brain")
print(table(brainexpr_full$gene_type))
print("liver")
print(table(liverexpr_full$gene_type))
print("testis")
print(table(testisexpr_full$gene_type))
```

### brain-Restricted | RNASeq

In this case, we want to determine brain specific genes. For that matter, the following criteria was applied:

* CRITERIA 2: TPM > 1 in at least 1 brain sample and TPM < 0.5 in all other tissues 

The same is performed for the rest tissues. 

```{r brainRestricted_Sara, echo=F}
######## SARA'S APPROACH - no more than 0.5 in any patient
toc_TPMs_subset = toc_TPMs %>% select(-c(chr))  %>% subset(gene_type == "lncRNA" | gene_type == "processed_pseudogene" | gene_type == "protein_coding" | gene_type == "novel") %>% unique()

#------------------ BRAIN ------------------#
## they should be brain-restricted in at least 2 patients
brainspecific = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(2:4)] > 1) >= 1 & rowSums(toc_TPMs_subset[, c(5:10)] < 0.5) == 6, ]
## merge with all info
brainspecific_full = merge(brainspecific, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
brainspecific_full = brainspecific_full %>% unique()

# brainspecific_full_in1 = brainspecific_full[rowSums(brainspecific_full[, c(5:7)] > 1) > 1,]
write.csv(brainspecific_full, file.path(save_wd,"brainRestricted.csv"), row.names = F)


#------------------ LIVER ------------------#
## they should be liver-restricted in at least 2 patients
liverspecific = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(5:7)] > 1) >= 1 & rowSums(toc_TPMs_subset[, c(2:4,8:10)] < 0.5) == 6, ]
## merge with all info
liverspecific_full = merge(liverspecific, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
liverspecific_full = liverspecific_full %>% unique()

# liverspecific_full_in1 = liverspecific_full[rowSums(liverspecific_full[, c(8:10)] > 1) > 1,]
write.csv(liverspecific_full, file.path(save_wd,"liverRestricted.csv"), row.names = F)

#------------------ TESTIS ------------------#
## they should be testis-restricted in at least 2 patients
testisspecific = toc_TPMs_subset[rowSums(toc_TPMs_subset[, c(8:10)] > 1) >= 1 & rowSums(toc_TPMs_subset[, c(2:7)] < 0.5) == 6, ]

## merge with all info
testisspecific_full = merge(testisspecific, toc_TPMs_long %>% select(gene_id, gene_name, gene_type), by=c("gene_id","gene_type","gene_name")) 
testisspecific_full = testisspecific_full %>% unique()

# testisspecific_full_in1 = testisspecific_full[rowSums(testisspecific_full[, c(11:13)] > 1) > 1,]
write.csv(testisspecific_full, file.path(save_wd,"testisRestricted.csv"), row.names = F)

print("brain")
print(table(brainspecific$gene_type))
print("liver")
print(table(liverspecific$gene_type))
print("testis")
print(table(testisspecific$gene_type))
```

```{r plots_expr_restr, echo=F}
## brain
brain_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(brainexpr) - nrow(brainspecific), nrow(brainspecific)))
a1 = ggpie(brain_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Brain") +  theme(legend.position = "none")


brainsp_genetype_plot = as.data.frame(table(brainspecific$gene_type))
a2 = ggpie(brainsp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Brain Restricted") +  theme(legend.position = "none")


## liver
liver_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(liverexpr) - nrow(liverspecific), nrow(liverspecific)))
b1 = ggpie(liver_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Liver")+  theme(legend.position = "none")

liversp_genetype_plot = as.data.frame(table(liverspecific$gene_type))
b2 =ggpie(liversp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Liver Restricted") +
    theme(legend.position = "none")


## testis
testis_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(testisexpr) - nrow(testisspecific), nrow(testisspecific)))
c1 = ggpie(testis_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Testis") +  theme(legend.position = "none")


testissp_genetype_plot = as.data.frame(table(testisspecific$gene_type))
c2 = ggpie(testissp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Testis Restricted") +
  theme(legend.position = "none")

top = ggarrange(a1,b1,c1, nrow=3)
bottom = ggarrange(a2,b2,c2, nrow=3)

ggarrange(top,bottom)
ggsave(file.path(plots_wd,"PNG/expressed_specific_piecharts.png"))
ggsave(file.path(plots_wd,"PDF/expressed_specific_piecharts.pdf"))
``` 



### Brain-Restricted | RNASeq & GTEx filter

We will use GTEx to filter those genes whose expression in other tissues is higher than 0.5.

In cases where several "sub-tissues" are available, we kept the highest value.

```{r, reading_GTEx, echo=F}
gtex = read.table("/data/genomics/marta/genomes/GTEx/v10/GTEx_maintissue_gene_median_tpm.csv", sep=",", header=T)
names(gtex)[1] = "gene_id"
nrow(gtex)
gtex$gene_id = gsub("\\..*","",gtex$gene_id)
```

```{r brain_GTEx, echo=F}
nrow(brainspecific_full)
brain_gtex = gtex %>% subset(gene_id %in% brainspecific_full$gene_id)
dim(brain_gtex)

## germline 
germline = brain_gtex %>% select(gene_id, Brain) 
germline_05 = germline %>% mutate(GTEx_brain = case_when(Brain > 0.5~ "> 0.5", Brain < 0.5 ~ "< 0.5"))
dim(germline_05)
## non-reproductive tissues
NOgermline = brain_gtex %>% select(-c(Brain))
rownames(NOgermline) = NOgermline$gene_id
NOgermline$gene_id = NULL
dim(NOgermline)

## get maximum value
NOgermline$max <- apply(NOgermline, 1, max, na.rm=TRUE)
NOgermline_05 = NOgermline %>% mutate("GTEx_healthy" = case_when(max > 0.5~ "> 0.5", max < 0.5 ~ "< 0.5"))
NOgermline_05$gene_id = rownames(NOgermline_05)
dim(NOgermline_05)
## join both criteria
GTEX_criteria = merge(NOgermline_05 %>% select(gene_id, GTEx_healthy), germline_05 %>% select(gene_id, GTEx_brain), by="gene_id")
dim(GTEX_criteria)
# length(unique(brainspecific_full$gene_id))
# nrow(GTEX_criteria)
subset_brain_full_GTEx = merge(brainspecific_full, GTEX_criteria, by="gene_id")
dim(subset_brain_full_GTEx)
# length(unique(subset_brain_full_GTEx$gene_id))

subset_brain_GTEx = subset_brain_full_GTEx %>% subset(GTEx_healthy == "< 0.5" & GTEx_brain == "> 0.5")
dim(subset_brain_GTEx)


subset_brain_GTEx_w_novels = brainspecific_full %>% subset(gene_type == "novel")
subset_brain_GTEx_w_novels$GTEx_healthy = NA
subset_brain_GTEx_w_novels$GTEx_brain = NA
subset_brain_GTEx_w_novels = rbind(subset_brain_GTEx_w_novels, subset_brain_GTEx)

write.csv(subset_brain_GTEx_w_novels, file.path(save_wd,"brainRestricted_GTEx.csv"), row.names = F)
nrow(subset_brain_GTEx_w_novels)
tmp = subset_brain_GTEx_w_novels %>% select(gene_id, gene_type) %>% unique()
table(tmp$gene_type)
```

**Of the expressed, how many are restricted based on Wang and based on GTEx?**

```{r expr_restr, echo=F}
brainExpressed = brainexpr_full %>% mutate("brainRestricted" = case_when(gene_id %in% brainspecific_full$gene_id ~ "yes", TRUE ~ "no")) %>%
  mutate("brainRestricted_GTEx" = case_when(gene_id %in% subset_brain_GTEx$gene_id ~ "yes", TRUE ~ "no"))
table(brainExpressed$gene_type)
##-------------- WANG et al.--------------##
table(brainExpressed$gene_type, brainExpressed$brainRestricted)
Wang_expressed_restricted = as.data.frame(table(brainExpressed$gene_type, brainExpressed$brainRestricted))
names(Wang_expressed_restricted) = c("gene_type","brainRestricted","n")
Wang_expressed_restricted = Wang_expressed_restricted %>% 
  group_by(gene_type) %>% 
  mutate(perc = round((n/sum(n)*100),2))

ggplot(Wang_expressed_restricted, aes(x=gene_type, y=n, fill=brainRestricted)) +
  geom_bar(stat="identity", position="fill") +
  geom_text(aes(label=paste0(perc, "%")), position=position_fill(vjust=0.5)) +
  scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
  scale_y_continuous(labels = scales::percent) +
  labs(x="Biotype",
        y="Number of genes",
        title="How many of the brainExpressed genes\nare brainRestricted (Wang et al.)?") +
  theme_classic() +
  theme(legend.position="top")

ggsave(file.path(plots_wd,"PNG/brainExpressed_brainRestricted.png"), height=5.69, width=4.72)
ggsave(file.path(plots_wd,"PDF/brainExpressed_brainRestricted.pdf"), height=5.69, width=4.72)


##-------------- GTEx et al.--------------##
GTEx_expressed_restricted = as.data.frame(table(brainExpressed$gene_type, brainExpressed$brainRestricted_GTEx))
names(GTEx_expressed_restricted) = c("gene_type","brainRestricted_GTEx","n")
GTEx_expressed_restricted = GTEx_expressed_restricted %>% 
  group_by(gene_type) %>% 
  mutate(perc = round((n/sum(n)*100),2))

## novels excluded cause they cannot be checked
ggplot(GTEx_expressed_restricted %>% subset(gene_type != "novel"), aes(x=gene_type, y=n, fill=brainRestricted_GTEx)) +
  geom_bar(stat="identity", position="fill") +
  geom_text(aes(label=paste0(perc, "%")), position=position_fill(vjust=0.5)) +
  scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
  scale_y_continuous(labels = scales::percent) +
  labs(x="Biotype",
        y="Number of genes",
        title="How many of the brainExpressed genes\nare brainRestricted GTEx?") +
  theme_classic() +
  theme(legend.position="top")

ggsave(file.path(plots_wd,"PNG/brainExpressed_brainRestricted_GTEx.png"), height=5.69, width=4.72)
ggsave(file.path(plots_wd,"PDF/brainExpressed_brainRestricted_GTEx.pdf"), height=5.69, width=4.72)
```

### brain-Restricted | only GTEx filter

If we only use GTEx to filter those genes whose expression in other tissues is higher than 0.5... without Wang.


```{r brain_onlyGTEx, echo=F}
nrow(brainexpr_full)
brain_only_gtex = gtex %>% subset(gene_id %in% brainexpr_full$gene_id)
dim(brain_only_gtex)

## germline 
germline = brain_only_gtex %>% select(gene_id, Brain) 
germline_05 = germline %>% mutate(GTEx_brain = case_when(Brain > 0.5~ "> 0.5", Brain < 0.5 ~ "< 0.5"))
dim(germline_05)
## non-reproductive tissues
NOgermline = brain_only_gtex %>% select(-c(Brain))
rownames(NOgermline) = NOgermline$gene_id
NOgermline$gene_id = NULL
dim(NOgermline)

## get maximum value
NOgermline$max <- apply(NOgermline, 1, max, na.rm=TRUE)
NOgermline_05 = NOgermline %>% mutate("GTEx_healthy" = case_when(max > 0.5~ "> 0.5", max < 0.5 ~ "< 0.5"))
NOgermline_05$gene_id = rownames(NOgermline_05)
dim(NOgermline_05)
## join both criteria
GTEX_criteria = merge(NOgermline_05 %>% select(gene_id, GTEx_healthy), germline_05 %>% select(gene_id, GTEx_brain), by="gene_id")
dim(GTEX_criteria)
# length(unique(brainspecific_full$gene_id))
# nrow(GTEX_criteria)
subset_brain_full_onlyGTEx = merge(brainexpr_full, GTEX_criteria, by="gene_id")
table(subset_brain_full_onlyGTEx$gene_type)
dim(subset_brain_full_onlyGTEx)
# length(unique(subset_brain_full_GTEx$gene_id))

subset_brain_onlyGTEx = subset_brain_full_onlyGTEx %>% subset(GTEx_healthy == "< 0.5" & GTEx_brain == "> 0.5")
dim(subset_brain_onlyGTEx)


subset_brain_onlyGTEx_w_novels = brainexpr_full %>% subset(gene_type == "novel")
subset_brain_onlyGTEx_w_novels$GTEx_healthy = NA
subset_brain_onlyGTEx_w_novels$GTEx_brain = NA
subset_brain_onlyGTEx_complete = rbind(subset_brain_onlyGTEx_w_novels, subset_brain_onlyGTEx)

write.csv(subset_brain_onlyGTEx_complete, file.path(save_wd,"brainRestricted_onlyGTEx.csv"), row.names = F)
nrow(subset_brain_onlyGTEx_complete)
tmp = subset_brain_onlyGTEx_complete %>% select(gene_id, gene_type) %>% unique()
table(tmp$gene_type)
```



## LIVER-RESTRICTED

```{r liver_GTEx, echo=F}
liver_gtex = gtex %>% subset(gene_id %in% liverspecific$gene_id)

## liver 
liver = liver_gtex %>% select(gene_id, Liver) 
liver_05 = liver %>% mutate(GTEx_liver = case_when(Liver > 0.5~ "> 0.5", Liver < 0.5 ~ "< 0.5"))

## all other tissues
all_others = liver_gtex %>% select(-c(Liver))
rownames(all_others) = all_others$gene_id
all_others$gene_id = NULL
## get maximum value
all_others$max <- apply(all_others, 1, max, na.rm=TRUE)
all_others_05 = all_others %>% mutate("GTEx_healthy" = case_when(max > 0.5~ "> 0.5", max < 0.5 ~ "< 0.5"))
all_others_05$gene_id = rownames(all_others_05)

## join both criteria
GTEX_criteria = merge(all_others_05 %>% select(gene_id, GTEx_healthy), liver_05 %>% select(gene_id, GTEx_liver), by="gene_id")

# length(unique(liverspecific$gene_id))
# nrow(GTEX_criteria)
subset_liver_full_GTEx = merge(liverspecific, GTEX_criteria, by="gene_id")
# length(unique(subset_liver_full_GTEx$gene_id))

subset_liver_GTEx = subset_liver_full_GTEx %>% subset(GTEx_healthy == "< 0.5" & GTEx_liver == "> 0.5")
dim(subset_liver_GTEx)


subset_liver_GTEx_w_novels = liverspecific_full %>% subset(gene_type == "novel")
subset_liver_GTEx_w_novels$GTEx_healthy = NA
subset_liver_GTEx_w_novels$GTEx_liver = NA
subset_liver_GTEx_w_novels = rbind(subset_liver_GTEx_w_novels, subset_liver_GTEx)

write.csv(subset_liver_GTEx_w_novels, file.path(save_wd,"liverRestricted_GTEx.csv"), row.names = F)
nrow(subset_liver_GTEx_w_novels)
tmp = subset_liver_GTEx_w_novels %>% select(gene_id, gene_type) %>% unique()
table(tmp$gene_type)
```

## testis-RESTRICTED

```{r testis_GTEx, echo=F}
testis_gtex = gtex %>% subset(gene_id %in% testisspecific$gene_id)

## testis 
testis = testis_gtex %>% select(gene_id, Testis) 
testis_05 = testis %>% mutate(GTEx_testis = case_when(Testis > 0.5~ "> 0.5", Testis < 0.5 ~ "< 0.5"))

## all other tissues
all_others = testis_gtex %>% select(-c(Testis))
rownames(all_others) = all_others$gene_id
all_others$gene_id = NULL
## get maximum value
all_others$max <- apply(all_others, 1, max, na.rm=TRUE)
all_others_05 = all_others %>% mutate("GTEx_healthy" = case_when(max > 0.5~ "> 0.5", max < 0.5 ~ "< 0.5"))
all_others_05$gene_id = rownames(all_others_05)

## join both criteria
GTEX_criteria = merge(all_others_05 %>% select(gene_id, GTEx_healthy), testis_05 %>% select(gene_id, GTEx_testis), by="gene_id")

# length(unique(testisspecific$gene_id))
# nrow(GTEX_criteria)
subset_testis_full_GTEx = merge(testisspecific, GTEX_criteria, by="gene_id")
# length(unique(subset_liver_full_GTEx$gene_id))

subset_testis_GTEx = subset_testis_full_GTEx %>% subset(GTEx_healthy == "< 0.5" & GTEx_testis == "> 0.5")
dim(subset_testis_GTEx)


subset_testis_GTEx_w_novels = testisspecific_full %>% subset(gene_type == "novel")
subset_testis_GTEx_w_novels$GTEx_healthy = NA
subset_testis_GTEx_w_novels$GTEx_testis = NA
subset_testis_GTEx_w_novels = rbind(subset_testis_GTEx_w_novels, subset_testis_GTEx)

write.csv(subset_testis_GTEx_w_novels, file.path(save_wd,"testisRestricted_GTEx.csv"), row.names = F)
nrow(subset_testis_GTEx_w_novels)
tmp = subset_testis_GTEx_w_novels %>% select(gene_id, gene_type) %>% unique()
table(tmp$gene_type)
```


```{r plots_expr_restr_GTex, echo=F}
## brain
brain_sp_gtex = read.csv(file.path(save_wd,"brainRestricted_GTEx.csv"))
brain_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(brainexpr) - nrow(brainspecific), nrow(brainspecific)- nrow(brain_sp_gtex), nrow(brain_sp_gtex)))
brain_expr_sp_gtex$tissue = "Brain"

## liver
liver_sp_gtex = read.csv(file.path(save_wd,"liverRestricted_GTEx.csv"))
liver_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(liverexpr) - nrow(liverspecific), nrow(liverspecific)- nrow(liver_sp_gtex), nrow(liver_sp_gtex)))
liver_expr_sp_gtex$tissue = "Liver"

## testis
testis_sp_gtex = read.csv(file.path(save_wd,"testisRestricted_GTEx.csv"))
testis_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(testisexpr) - nrow(testisspecific), nrow(testisspecific)- nrow(testis_sp_gtex), nrow(testis_sp_gtex)))
testis_expr_sp_gtex$tissue = "Testis"

merged_spGTEx = rbind(testis_expr_sp_gtex, liver_expr_sp_gtex, brain_expr_sp_gtex)
ggplot(merged_spGTEx, aes(x=tissue, fill=condition, y=values)) +
  geom_bar(position="fill", stat="identity") +
  labs(y="", title="Proportion of genes per condition and tissue") +
  scale_fill_manual(values=c("Expressed" = "#d9f0d3","Restricted" = "#5aae61", "Restricted with GTEx" = "#00441b")) +
  theme_minimal()
ggsave(file.path(plots_wd,"PNG/condition_tissue_barplot.png"))
ggsave(file.path(plots_wd,"PDF/condition_tissue_barplot.pdf"))

## plots
brainspgtex_genetype_plot = as.data.frame(table(brain_sp_gtex$gene_type))
a3 = ggpie(brainspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Brain Restricted with GTEx") +  theme(legend.position = "none")


## liver
liverspgtex_genetype_plot = as.data.frame(table(liver_sp_gtex$gene_type))
b3 = ggpie(liverspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Liver Restricted with GTEx") +
    theme(legend.position = "none")


## testis
testisspgtex_genetype_plot = as.data.frame(table(testis_sp_gtex$gene_type))
c3 = ggpie(testisspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Testis Restricted with GTEx") +
  theme(legend.position = "none")

ggarrange(a3,b3,c3, nrow=1)
ggsave(file.path(plots_wd,"PNG/Restricted_with_GTEx_piecharts.png"))
ggsave(file.path(plots_wd,"PDF/Restricted_with_GTEx_piecharts.pdf"))


``` 


## Human Data | RiboSeq

#### Brain-Expressed with RiboSeq

```{r translation_Expressed,echo=F}
## translation
ribORF_humanbrain_in1_fastas = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q1_TestisORFs/human/brain/ribORF_humanbrain_in1.csv")
table(ribORF_humanbrain_in1_fastas$gene_type)
table(ribORF_humanbrain_in1_fastas$geneORFtype)

nrow(brainExpressed)
table(brainExpressed$gene_type)
## how many of the brain expressed are translated?
brainExpressed_Restricted_Translated = merge(brainExpressed %>% select(gene_id, gene_name, brainRestricted), ribORF_humanbrain_in1_fastas, by=c("gene_id","gene_name"))
nrow(brainExpressed_Restricted_Translated)
print("orfs")
table(brainExpressed_Restricted_Translated$gene_type)
print("altORFs")
table(brainExpressed_Restricted_Translated$geneORFtype)
print("genes")
table(brainExpressed_Restricted_Translated %>% select(gene_id, gene_type) %>% unique() %>% pull(gene_type))
print("orfs brain-restricted")
table(brainExpressed_Restricted_Translated$brainRestricted, brainExpressed_Restricted_Translated$gene_type)
print("altORFs brain-restricted")
table(brainExpressed_Restricted_Translated$brainRestricted, brainExpressed_Restricted_Translated$geneORFtype)
print("genes brain-restricted")
table(brainExpressed_Restricted_Translated %>% subset(brainRestricted == "yes")%>% select(gene_id, gene_type) %>% unique() %>% pull(gene_type))
tp=brainExpressed_Restricted_Translated %>% subset(brainRestricted == "yes")%>% select(gene_id, gene_type, geneORFtype) %>% unique()
table(tp$gene_type, tp$geneORFtype)

brainExpressed_Restricted_Translated = brainExpressed_Restricted_Translated %>% select(-ORFseq)

to_plot = brainExpressed_Restricted_Translated %>% group_by(gene_type) %>% count()
to_plot = as.data.frame(to_plot)
ggpie(to_plot, "n", label="n", fill="gene_type", lab.pos = "out", lab.font = c(3, "plain", "black"),
      palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) +
  ggtitle("ORFs from brain-Expressed genes only translated in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainExpressed_translated.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainExpressed_translated.pdf"), height=4.69, width=5.4)

to_plot = brainExpressed_Restricted_Translated %>% group_by(geneORFtype) %>% count()
to_plot = as.data.frame(to_plot)
ggpie(to_plot, "n", label="n", fill="geneORFtype", lab.pos = "out", lab.font = c(3, "plain", "black"),
      # palette=c("protein_coding"="#CC79A7",
      #            "lncRNA" = "#009E73",
      #            "processed_pseudogene" = "#0090B2",
      #            "novel" = "#E69F00")
      ) +
  ggtitle("ORFs from brain-Expressed genes only translated in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainExpressed_translated_altORFs.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainExpressed_translated_altORFs.pdf"), height=4.69, width=5.4)
```

#### brain-Specific with RiboSeq

```{r translation_brainRestricted,echo=F}
brainRestrictedGTEx_Translated = merge(subset_brain_GTEx_w_novels %>% select(gene_id, gene_name), ribORF_humanbrain_in1_fastas, by=c("gene_id","gene_name")) 
write.csv(brainRestrictedGTEx_Translated, file.path(save_wd, "brainRestricted_GTEx_translatedINbrain.csv"), row.names = F, quote = F)

## how many brain REstricted GTEx are translated?
nrow(brainRestrictedGTEx_Translated)
print("orfs")
table(brainRestrictedGTEx_Translated$gene_type)
print("altORFs")
table(brainRestrictedGTEx_Translated$geneORFtype)
print("genes")
table(brainRestrictedGTEx_Translated %>% select(gene_id, gene_type) %>% unique() %>% pull(gene_type))
brainRestrictedGTEx_Translated = brainRestrictedGTEx_Translated %>% select(-ORFseq)
tp=brainRestrictedGTEx_Translated %>% select(gene_id, gene_type, geneORFtype) %>% unique()
table(tp$gene_type, tp$geneORFtype)


dim(brainRestrictedGTEx_Translated)
to_plot = brainRestrictedGTEx_Translated %>% group_by(gene_type) %>% count()
to_plot = as.data.frame(to_plot)
ggpie(to_plot, "n", label="n", fill="gene_type", lab.pos = "out",   lab.font = c(5, "plain", "black"),
      palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) +
  ggtitle("ORFs from brain-Restricted GTEx genes translated in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainRestrictedGTEx_translated.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainRestrictedGTEx_translated.pdf"), height=4.69, width=5.4)

to_plot = brainRestrictedGTEx_Translated %>% group_by(geneORFtype) %>% count()
to_plot = as.data.frame(to_plot)
ggpie(to_plot, "n", label="n", fill="geneORFtype", lab.pos = "out",   lab.font = c(5, "plain", "black"),
      palette=c("protein_coding_canonical"="#ead890",
                       "lncRNA_noncoding" = "#cd4f38",
                       "processed_pseudogene_noncoding" = "#e48c2a",
                                             "novel_noncoding" = "#637c68",
                       "protein_coding_uORF"="#899da4",
                       "protein_coding_ouORF"="#c5d0ca",
                       "protein_coding_dORF"="#ba968a",
                       "protein_coding_odORF"="#f2c695")) +
  ggtitle("ORFs from brain-Restricted GTEx genes translated in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainRestrictedGTEx_translated_altORFs.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainRestrictedGTEx_translated_altORFs.pdf"), height=4.69, width=5.4)
```

```{r translation_brainRestricted_onlyGTEX,echo=F}
print("ONLY GTEx")
brainRestrictedONLYGTEx_Translated = merge(subset_brain_onlyGTEx_complete %>% select(gene_id, gene_name), ribORF_humanbrain_in1_fastas, by=c("gene_id","gene_name")) 
write.csv(brainRestrictedONLYGTEx_Translated, file.path(save_wd, "brainRestricted_onlyGTEx_translatedINbrain.csv"), row.names = F, quote = F)

## how many brain REstricted GTEx are translated?
nrow(brainRestrictedONLYGTEx_Translated)
print("orfs")
table(brainRestrictedONLYGTEx_Translated$gene_type)
print("altORFs")
table(brainRestrictedONLYGTEx_Translated$geneORFtype)
print("genes")
table(brainRestrictedONLYGTEx_Translated %>% select(gene_id, gene_type) %>% unique() %>% pull(gene_type))
brainRestrictedONLYGTEx_Translated = brainRestrictedONLYGTEx_Translated %>% select(-ORFseq)
tp=brainRestrictedONLYGTEx_Translated %>% select(gene_id, gene_type, geneORFtype) %>% unique()
table(tp$gene_type, tp$geneORFtype)

dim(brainRestrictedONLYGTEx_Translated)
to_plot = brainRestrictedONLYGTEx_Translated %>% group_by(gene_type) %>% count()
to_plot = as.data.frame(to_plot)
# ggpie(to_plot, "n", label="n", fill="gene_type", lab.pos = "out",   lab.font = c(5, "plain", "black"),
#       palette=c("protein_coding"="#CC79A7",
#                  "lncRNA" = "#009E73",
#                  "processed_pseudogene" = "#0090B2",
#                  "novel" = "#E69F00")) +
#   ggtitle("ORFs from brain-Restricted GTEx genes translated in brain (1 sample at least)")
# ggsave(file.path(plots_wd,"PNG/brainRestrictedGTEx_translated.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainRestrictedGTEx_translated.pdf"), height=4.69, width=5.4)
# 
# to_plot = brainRestrictedGTEx_Translated %>% group_by(geneORFtype) %>% count()
# to_plot = as.data.frame(to_plot)
# ggpie(to_plot, "n", label="n", fill="geneORFtype", lab.pos = "out",   lab.font = c(5, "plain", "black"),
      # palette=c("protein_coding"="#CC79A7",
      #            "lncRNA" = "#009E73",
      #            "processed_pseudogene" = "#0090B2",
      #            "novel" = "#E69F00")
      # ) +
#   ggtitle("ORFs from brain-Restricted GTEx genes translated in brain (1 sample at least)")
# ggsave(file.path(plots_wd,"PNG/brainRestrictedGTEx_translated_altORFs.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainRestrictedGTEx_translated_altORFs.pdf"), height=4.69, width=5.4)
```

Of the brain-restricted genes, which proportion of the ncORFs/canonical ORFs that are translated in at least 2 brain samples are **only translated** in brain? 

```{r brainTranslated_in_tissues, echo=F}
## ---------- LIVER -----------##
ribORF_humanLiver_Annotated_biotypes = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q1_TestisORFs/human/brain/ribORF_humanLiver_translated.csv")
ribORF_humanLiver_Annotated_biotypes = ribORF_humanLiver_Annotated_biotypes %>% mutate(geneORFtype = paste0(gene_type,"_",orfType))

ribORF_humanLiver_simplified = ribORF_humanLiver_Annotated_biotypes %>% select(orfID, gene_type, geneORFtype, gene_id, sample) %>% 
  group_by(orfID, gene_type, gene_id, geneORFtype) %>% count()
names(ribORF_humanLiver_simplified)[5] = "num_samples"
ribORF_humanLiver_simplified$tissue = "liver"

## ---------- TESTIS -----------##
ribORF_humantestis_Annotated_biotypes = read.csv( "/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q1_TestisORFs/human/brain/ribORF_humantestis_translated.csv")
ribORF_humantestis_Annotated_biotypes = ribORF_humantestis_Annotated_biotypes %>% mutate(geneORFtype = paste0(gene_type,"_",orfType))

ribORF_humantestis_simplified = ribORF_humantestis_Annotated_biotypes %>% select(orfID, gene_type, geneORFtype, gene_id, sample) %>% 
  group_by(orfID, gene_type, gene_id, geneORFtype) %>% count()
names(ribORF_humantestis_simplified)[4] = "num_samples"
ribORF_humantestis_simplified$tissue = "testis"

ggvenn(list("testis"=ribORF_humantestis_simplified$orfID,
                 "liver"=ribORF_humanLiver_simplified$orfID,
                 "brain"=brainRestrictedGTEx_Translated$orfID),
       fill_alpha=0.5, stroke_color="gray", set_name_size = 4, text_size=3, fill_color = c("#8C57A2","#ABCD72","#82581F")) +
  ggtitle("Translated ORFs per tissues")
ggsave(file.path(plots_wd,"PNG/brainRestricted_translated_tissues.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainRestricted_translated_tissues.pdf"), height=4.69, width=5.4)

ggvenn(list("testis"=ribORF_humantestis_simplified %>% subset(gene_type == "lncRNA") %>% pull(orfID),
                 "liver"=ribORF_humanLiver_simplified %>% subset(gene_type == "lncRNA") %>% pull(orfID),
                 "brain"=brainRestrictedGTEx_Translated %>% subset(gene_type == "lncRNA") %>% pull(orfID)),
       fill_alpha=0.5, stroke_color="gray", set_name_size = 4, text_size=3, fill_color = c("#8C57A2","#ABCD72","#82581F")) +
  ggtitle("Translated lncRNA-ORFs per tissues")
ggsave(file.path(plots_wd,"PNG/brainRestricted_translated_tissues_lncRNA.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainRestricted_translated_tissues_lncRNA.pdf"), height=4.69, width=5.4)

ggvenn(list("testis"=ribORF_humantestis_simplified %>% subset(gene_type == "protein_coding") %>% pull(orfID),
                 "liver"=ribORF_humanLiver_simplified %>% subset(gene_type == "protein_coding") %>% pull(orfID),
                 "brain"=brainRestrictedGTEx_Translated %>% subset(gene_type == "protein_coding") %>% pull(orfID)),
       fill_alpha=0.5, stroke_color="gray", set_name_size = 4, text_size=3, fill_color = c("#8C57A2","#ABCD72","#82581F")) +
  ggtitle("Translated CDSs per tissues")
ggsave(file.path(plots_wd,"PNG/brainRestricted_translated_tissues_proteincoding.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainRestricted_translated_tissues_proteincoding.pdf"), height=4.69, width=5.4)

brainRestrictedGTEx_Translated = brainRestrictedGTEx_Translated %>% mutate("TranslatedLiver" = case_when(orfID %in% ribORF_humanLiver_simplified$orfID ~ "yes",TRUE ~ "no")) %>% mutate("TranslatedTestis" = case_when(orfID %in% ribORF_humantestis_simplified$orfID ~ "yes",TRUE ~ "no"))

## select those only TRANSLATED in brain (in at least 2 samples) and no in any sample from brain or liver 
brainRestrictedGTEx_Translated_onlybrain = brainRestrictedGTEx_Translated %>% subset(TranslatedLiver == "no" & TranslatedTestis == "no")
write.csv(brainRestrictedGTEx_Translated_onlybrain, file.path(save_wd, "brainRestricted_GTEx_translatedONLYbrain.csv"), row.names = F, quote = F)
print("orfs")
table(brainRestrictedGTEx_Translated_onlybrain$gene_type)
print("altORFs")
table(brainRestrictedGTEx_Translated_onlybrain$geneORFtype)
print("genes")
table(brainRestrictedGTEx_Translated_onlybrain %>% select(gene_id, geneORFtype) %>% unique() %>% pull(geneORFtype))

to_plot_translatedOnlybrain = brainRestrictedGTEx_Translated_onlybrain %>% group_by(gene_type) %>% count()
to_plot_translatedOnlybrain = as.data.frame(to_plot_translatedOnlybrain)

###### ggpie
labs <- paste0(to_plot_translatedOnlybrain$gene_type, " ( ",to_plot_translatedOnlybrain$n, ")")
ggpie(to_plot_translatedOnlybrain, "n", label="n", fill="gene_type", lab.pos = "out", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) +
  ggtitle("ORFs from brain-expressed genes translated ONLY in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainRestricted_ORFs_onlybrain.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainREstricted_ORFs_onlybrain.pdf"), height=4.69, width=5.4)  

to_plot_translatedOnlybrain = brainRestrictedGTEx_Translated_onlybrain %>% group_by(geneORFtype) %>% count()
to_plot_translatedOnlybrain = as.data.frame(to_plot_translatedOnlybrain)
ggpie(to_plot_translatedOnlybrain, "n", label="n", fill="geneORFtype", lab.pos = "out", 
      palette=c("protein_coding_canonical"="#ead890",
                       "lncRNA_noncoding" = "#cd4f38",
                       "processed_pseudogene_noncoding" = "#e48c2a",
                                             "novel_noncoding" = "#637c68",
                       "protein_coding_uORF"="#899da4",
                       "protein_coding_ouORF"="#c5d0ca",
                       "protein_coding_dORF"="#ba968a",
                       "protein_coding_odORF"="#f2c695")
                         ) +
  ggtitle("ORFs from brain-expressed genes translated ONLY in brain (1 sample at least)")
ggsave(file.path(plots_wd,"PNG/brainRestricted_altORFs_onlybrain.png"), height=4.69, width=5.4)
ggsave(file.path(plots_wd,"PDF/brainREstricted_altORFs_onlybrain.pdf"), height=4.69, width=5.4)  
```

```{r plots_expr_sp_transl, echo=F}
## testis
transl_testisspecific = testisspecific %>% subset(gene_id %in% ribORF_humantestis_Annotated_biotypes$gene_id)
transl_testisexpr = testisexpr %>% subset(gene_id %in% ribORF_humantestis_Annotated_biotypes$gene_id)
transl_testis_sp_gtex = testis_sp_gtex %>% subset(gene_id %in% ribORF_humantestis_Annotated_biotypes$gene_id)
## liver
transl_liverspecific = liverspecific %>% subset(gene_id %in% ribORF_humanLiver_Annotated_biotypes$gene_id)
transl_liverexpr = liverexpr %>% subset(gene_id %in% ribORF_humanLiver_Annotated_biotypes$gene_id)
transl_liver_sp_gtex = liver_sp_gtex %>% subset(gene_id %in% ribORF_humanLiver_Annotated_biotypes$gene_id)
## brain
transl_brainspecific = brainspecific %>% subset(gene_id %in% ribORF_humanbrain_in1_fastas$gene_id)
transl_brainexpr = brainexpr %>% subset(gene_id %in% ribORF_humanbrain_in1_fastas$gene_id)
transl_brain_sp_gtex = brain_sp_gtex %>% subset(gene_id %in% ribORF_humanbrain_in1_fastas$gene_id)


## brain
transl_brain_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(transl_brainexpr) - nrow(transl_brainspecific), nrow(transl_brainspecific)))
a1 = ggpie(brain_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Brain (Translated)") +  theme(legend.position = "none")


transl_brainsp_genetype_plot = as.data.frame(table(transl_brainspecific$gene_type))
a2 = ggpie(transl_brainsp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Brain Restricted (Translated)") +  theme(legend.position = "none")


## liver
transl_liver_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(transl_liverexpr) - nrow(transl_liverspecific), nrow(transl_liverspecific)))
b1 = ggpie(transl_liver_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Liver (Translated)")+  theme(legend.position = "none")

transl_liversp_genetype_plot = as.data.frame(table(transl_liverspecific$gene_type))
b2 =ggpie(transl_liversp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Liver Restricted (Translated)") +
    theme(legend.position = "none")


## testis
transl_testis_piechart_expr_sp = data.frame(condition = c("Expressed", "Restricted"),
                                    values = c(nrow(transl_testisexpr) - nrow(transl_testisspecific), nrow(transl_testisspecific)))
c1 = ggpie(transl_testis_piechart_expr_sp, x="values", fill="condition", palette=c("Expressed" = "#5aae61",
                                                    "Restricted" = "#d9f0d3")) + 
  ggtitle("Testis (Translated)") +  theme(legend.position = "none")


transl_testissp_genetype_plot = as.data.frame(table(transl_testisspecific$gene_type))
c2 = ggpie(transl_testissp_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Testis Restricted (Translated)") +
  theme(legend.position = "none")

top = ggarrange(a1,b1,c1, nrow=3)
bottom = ggarrange(a2,b2,c2, nrow=3)

ggarrange(top,bottom)
ggsave(file.path(plots_wd,"PNG/translated_expressed_specific_piecharts.png"))
ggsave(file.path(plots_wd,"PDF/translated_expressed_specific_piecharts.pdf"))

## brain
transl_brain_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(transl_brainexpr) - nrow(transl_brainspecific), nrow(transl_brainspecific)- nrow(transl_brain_sp_gtex), nrow(transl_brain_sp_gtex)))
transl_brain_expr_sp_gtex$tissue = "Brain"

## liver
transl_liver_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(transl_liverexpr) - nrow(transl_liverspecific), nrow(transl_liverspecific)- nrow(transl_liver_sp_gtex), nrow(transl_liver_sp_gtex)))
transl_liver_expr_sp_gtex$tissue = "Liver"

## testis
transl_testis_expr_sp_gtex = data.frame(condition = c("Expressed", "Restricted", "Restricted with GTEx"),
                                    values = c(nrow(transl_testisexpr) - nrow(transl_testisspecific), nrow(transl_testisspecific)- nrow(transl_testis_sp_gtex), nrow(transl_testis_sp_gtex)))
transl_testis_expr_sp_gtex$tissue = "Testis"

merged_spGTEx_transl = rbind(transl_testis_expr_sp_gtex, transl_liver_expr_sp_gtex, transl_brain_expr_sp_gtex)
ggplot(merged_spGTEx_transl, aes(x=tissue, fill=condition, y=values)) +
  geom_bar(position="fill", stat="identity") +
  labs(y="", title="Proportion of genes translated per condition and tissue") +
  scale_fill_manual(values=c("Expressed" = "#d9f0d3","Restricted" = "#5aae61", "Restricted with GTEx" = "#00441b")) +
  theme_minimal()
ggsave(file.path(plots_wd,"PNG/condition_tissue_barplot_translated.png"))
ggsave(file.path(plots_wd,"PDF/condition_tissue_barplot_translated.pdf"))

## plots
transl_brainspgtex_genetype_plot = as.data.frame(table(transl_brain_sp_gtex$gene_type))
a3 = ggpie(transl_brainspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Translated Brain Restricted with GTEx") +  theme(legend.position = "none")


## liver
transl_liverspgtex_genetype_plot = as.data.frame(table(transl_liver_sp_gtex$gene_type))
b3 = ggpie(transl_liverspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Translated Liver Restricted with GTEx") +
    theme(legend.position = "none")


## testis
transl_testisspgtex_genetype_plot = as.data.frame(table(transl_testis_sp_gtex$gene_type))
c3 = ggpie(transl_testisspgtex_genetype_plot, x="Freq", fill = "Var1", palette=c("protein_coding"="#ead890",
                       "lncRNA" = "#cd4f38",
                       "processed_pseudogene" = "#e48c2a",
                                             "novel" = "#637c68")) + 
  ggtitle("Translated Testis Restricted with GTEx") +
  theme(legend.position = "none")

gtex = ggarrange(a3,b3,c3, nrow=1)
ggsave(file.path(plots_wd,"PNG/Translated_Restricted_with_GTEx_piecharts.png"))
ggsave(file.path(plots_wd,"PDF/Translated_Restricted_with_GTEx_piecharts.pdf"))

gtex = ggarrange(a3,b3,c3, ncol=1)

ggarrange(top,gtex, nrow=1)
```


```{r differences_Expressed_GTEx, echo=F}
brainExpressed_Restricted_Translated_GTEx = brainExpressed_Restricted_Translated %>% mutate(RestrictedGTEx = case_when(orfID %in% brainRestrictedGTEx_Translated_onlybrain$orfID ~ "yes",
                                                                                                                    TRUE ~ "no"))
# ##---------- length differences ----------##
# ggplot(brainExpressed_Restricted_Translated_GTEx, aes(x=RestrictedGTEx, y=length_aa, fill=RestrictedGTEx)) +
#   geom_violin() +
#   stat_compare_means() +
#   scale_y_continuous(trans="log10") +
#     scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
#   labs(title="Translated brainExpressed & brainRestrictedGTEx ORFs") +
#   theme_classic()
# ggsave(file.path(plots_wd,"PNG/brainRestrictedGTEx_lengthAA.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainRestrictedGTEx_lengthAA.pdf"), height=4.69, width=5.4)
# 
# ##---------- length differences | gene_type ----------##
# ggplot(brainExpressed_Restricted_Translated_GTEx, aes(x=gene_type, y=length_aa, fill=RestrictedGTEx)) +
#   geom_boxplot() +
#   stat_compare_means(label="p.signif") +
#   scale_y_continuous(trans="log10") +
#   scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
#   labs(title="Translated brainExpressed & brainRestrictedGTEx ORFs") +
#   theme_classic()
# ggsave(file.path(plots_wd,"PNG/brainExpressed_brainRestrictedGTEx_lengthAA_genetype.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainExpressed_brainRestrictedGTEx_lengthAA_genetype.pdf"), height=4.69, width=5.4)
# ##---------- composition differences ----------##
# ## log2ratio to see if ncORFs are relatively enriched in any aminoacid
# # Function to calculate log2ratio of relative frequency
# calculate_log2ratio_df <- function(group1_seqs, group2_seqs) {
#   all_amino_acids <- c("A","R","N","D","C","Q","E","G","H","U","L","K","M","F","P","S","T","W","Y","V", "*")
#   log2ratios <- numeric(length(all_amino_acids))
#   
#   for (aa in all_amino_acids) {
#     count_group1 <- sum(sapply(group1_seqs, function(seq) sum(unlist(strsplit(as.character(seq), "")) == aa)))
#     count_group2 <- sum(sapply(group2_seqs, function(seq) sum(unlist(strsplit(as.character(seq), "")) == aa)))
#     
#     freq_group1 <- count_group1 / sum(sapply(group1_seqs, nchar))
#     freq_group2 <- count_group2 / sum(sapply(group2_seqs, nchar))
#     
#     log2ratios[aa] <- log2(freq_group1 / freq_group2)
#   }
#   
#   log2ratio_df <- data.frame(Aminoacid = all_amino_acids, log2ratio = log2ratios)
#   return(log2ratio_df)
# }
# 
# ## select ncORFs - no brainRestricted
# ncORFs_no_seqs = brainExpressed_Restricted_Translated_GTEx %>% subset(orfType == "noncoding") %>% subset(RestrictedGTEx == "no")
# ncORFs_no_seqs = as.character(ncORFs_no_seqs$ORFpep)
# ## select ncORFs - brainRestricted
# ncORFs_yes_seqs = brainExpressed_Restricted_Translated_GTEx %>% subset(orfType == "noncoding") %>% subset(RestrictedGTEx == "yes")
# ncORFs_yes_seqs = as.character(ncORFs_yes_seqs$ORFpep)
# 
# ## select ORFs - no brainRestricted
# ORFs_no_seqs = brainExpressed_Restricted_Translated_GTEx %>% subset(orfType == "canonical") %>% subset(RestrictedGTEx == "no")
# ORFs_no_seqs = as.character(ORFs_no_seqs$ORFpep)
# ## select ORFs - brainRestricted
# ORFs_yes_seqs = brainExpressed_Restricted_Translated_GTEx %>% subset(orfType == "canonical") %>% subset(RestrictedGTEx == "yes")
# ORFs_yes_seqs = as.character(ORFs_yes_seqs$ORFpep)
# 
# ## compute log2ratio per letter - ncORFs
# log2ratios_ncORFs = calculate_log2ratio_df(ncORFs_yes_seqs, ncORFs_no_seqs)
# print(log2ratios_ncORFs)
# names(log2ratios_ncORFs)[2] = "ncORFs_yes_vs_no"
# log2ratios_ncORFs = log2ratios_ncORFs %>% subset(ncORFs_yes_vs_no != 0)
# 
# ## compute log2ratio per letter - CDS
# log2ratios_CDS = calculate_log2ratio_df(ORFs_yes_seqs, ORFs_no_seqs)
# names(log2ratios_CDS)[2] = "CDS_yes_vs_no"
# log2ratios_CDS = log2ratios_CDS %>% subset(CDS_yes_vs_no != 0)
# 
# hph=c("A","V","L","I","M","F","Y","W")
# polar=c("S","T","N","Q")
# positively_charged=c("R","H","K")
# negatively_charged=c("D","E")
# special_cases=c("C","G","P")
# 
# 
# log2ratios = list(log2ratios_ncORFs, log2ratios_CDS) %>% reduce(full_join, by='Aminoacid')
# log2ratios = log2ratios %>% 
#   mutate(aa_type = case_when(Aminoacid %in% hph ~ "hidrophobic",
#                              Aminoacid %in% polar ~ "polar",
#                              Aminoacid %in% positively_charged ~ "positive",
#                              Aminoacid %in% negatively_charged ~ "negative",
#                              Aminoacid %in% special_cases ~ "special")) %>%
#   subset(Aminoacid != "*") %>% 
#   drop_na()
# 
# log2ratios = log2ratios %>% pivot_longer(cols=c("ncORFs_yes_vs_no","CDS_yes_vs_no"), names_to = "type", values_to = "log2ratio")
# 
# ggplot(log2ratios, aes(x=Aminoacid, y=log2ratio, fill = aa_type)) +
#   geom_bar(stat = "identity") +
#   scale_fill_carto_d(palette="Burg")+
#   labs(y="Log2Ratio",
#        x="Aminoacid",
#        title="Relative enrichement of aminoacids in ncORFs",
#        fill="Aminoacid type") +
#   theme_classic() +
#   theme(legend.position = "top") +
#   facet_grid(type ~ aa_type, scales="free_x", space="free_x")
# ggsave(file.path(plots_wd,"PNG/log2ratio_severalconditions.png"), height=7.05, width=8.46)
# ggsave(file.path(plots_wd,"PDF/log2ratio_severalconditions.pdf"), height=7.05, width=8.46)
# 
# 
# ##---------- translation efficiency ----------##
# # mean_brain_TE = read.csv("/projects_eg/projects/marta/brainRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q1_brainORFs/human/mean_translationEfficiency_brain.csv")
# # names(mean_brain_TE)[5] = "orfType"
# # brainExpressed_Restricted_Translated_GTEx = merge(brainExpressed_Restricted_Translated_GTEx,mean_brain_TE, by=c("orfID"gene_id "gene_type "gene_name "orfType))
# 
# ggplot(brainExpressed_Restricted_Translated_GTEx, aes(x=RestrictedGTEx, y=mean_TE, fill=RestrictedGTEx)) +
#   geom_boxplot() +
#   stat_compare_means() +
#   scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
#   scale_y_continuous(trans="log10") +
#   labs(title="Translated brainExpressed & brainRestrictedGTEx ORFs") +
#   theme_classic()
# ggsave(file.path(plots_wd,"PNG/brainExpressed_brainRestrictedGTEx_TE.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainExpressed_brainRestrictedGTEx_TE.pdf"), height=4.69, width=5.4)
# 
# ##---------- translation efficiency | gene_type ----------##
# ggplot(brainExpressed_Restricted_Translated_GTEx, aes(x=gene_type, y=mean_TE, fill=RestrictedGTEx)) +
#   geom_boxplot() +
#   stat_compare_means(label="p.signif") +
#   scale_fill_manual(values=c("yes" = "#B1283A", "no"="#A8A6A7")) +
#   scale_y_continuous(trans="log10") +
#   labs(title="Translated brainExpressed & brainRestrictedGTEx ORFs") +
#   theme_classic()
# ggsave(file.path(plots_wd,"PNG/brainExpressed_brainRestrictedGTEx_TE_genetype.png"), height=4.69, width=5.4)
# ggsave(file.path(plots_wd,"PDF/brainExpressed_brainRestrictedGTEx_TE_genetype.pdf"), height=4.69, width=5.4)  
```

## CTDB

```{r CTDB, echo=F}
CTDB = read.csv("/projects_eg/projects/marta/CTdatabase_list.csv", sep="\t")
CTDB = CTDB %>% mutate(X_A = case_when(grepl("^X", chr) ~ "X",
                                       TRUE ~ "A"))
print(nrow(CTDB))
print(nrow(brainExpressed_Restricted_Translated_GTEx %>% subset(gene_name %in% CTDB$gene_name)))
CTDB_translated_only_brain = merge(brainExpressed_Restricted_Translated_GTEx, CTDB, by="gene_name")
table(CTDB_translated_only_brain$X_A)
## non-X are more dominantly expressed in germ-cell differentation late stages such as spermatocytes
## CT-X are generally expressed in the speratogonia, wchich are proliferating germ cells.

notFound = CTDB %>% subset(!gene_name %in% CTDB_translated_only_brain$gene_name)
print(nrow(notFound))
```