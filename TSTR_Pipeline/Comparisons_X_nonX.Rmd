---
title: "Comparisons X and nonX TSTR"
author: "Marta Espinosa"
date: "2024-12-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(purrr)
library(ggvenn)
library(ggpubr)
library(ggside)
library(bioseq)
# library(ggthemr)
library(ggbeeswarm)
library(ggbreak)
library(ggrepel)
library(rcartocolor)
library(UpSetR)
library(karyoploteR)
library(GenomicRanges)
library(rtracklayer)
library(Hmisc)
library(corrplot)
library(stats)
library(car)
library(ggpattern)
library(ComplexUpset)
library(fmsb)

annot = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/human/newReference_Resconstructed/transID_geneID_isoforms_selected.1to1.csv")
plots_wd="/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/PreparationPlots/MultiMap_altORFs/X_nonX"

cancers = c("BRCA","BLCA","LUAD","KIRC","PRAD","LUSC","COAD","LIHC")
tcga_projects=c("TCGA-BRCA","TCGA-LUSC","TCGA-PRAD","TCGA-KIRC","TCGA-LUAD","TCGA-BLCA")
other_projects=c("GSE102101_KIRC","GSE133624_BLCA","GSE22260_PRAD","PRJEB2449_PRAD","SRP238334_KIRC","GSE214846_LIHC","GSE229705_LUAD","TCGA_COAD","SRP107326_COAD")
manuscript_projects = c("liver_adjacent_totalRNA_LIHC","hcc_normal_totalRNA_LIHC","GSE193567_LIHC","LIHC_TCGA_LIHC")
# deleted_projects=c("GSE103001_BRCA"GSE89223_PRAD")
all_projects = c(tcga_projects,other_projects,manuscript_projects)

tumorReactDIR = "/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/cancers/log2ratio3x/cancertypes"
cancers_dir = "/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/cancers"

CTDB = read.csv("/projects_eg/projects/marta/CTdatabase_list.csv", sep="\t")
CTDB = CTDB %>% mutate(X_A = case_when(grepl("^X", chr) ~ "X",
                                       TRUE ~ "A"))
CTDB = separate_rows(CTDB, gene_name, sep = "/")
CTDB = separate_rows(CTDB, gene_name, sep = ",")
CTDB_in_annot = CTDB %>% subset(gene_name %in% annot$gene_name)

total_num_patients = data.frame(ctype = c("BRCA","BLCA","LUAD","KIRC","LUSC","PRAD","LIHC","COAD"),
                                total_n = c(109,38,179,142,49,75,182,144))

# Function to compute the required statistics
compute_stats <- function(row) {
  mean_value <- mean(row)
  median_value <- median(row)
  sd_value <- sd(row)
  q1_value <- quantile(row, 0.25)
  q3_value <- quantile(row, 0.75)
  
  return(c(mean = mean_value, median = median_value, sd = sd_value, Q1 = q1_value, Q3 = q3_value))
}

# Function to calculate log2ratio of relative frequency
calculate_log2ratio_df <- function(group1_seqs, group2_seqs) {
  all_amino_acids <- c("A","R","N","D","C","Q","E","G","H","U","L","K","M","F","P","S","T","W","Y","V", "*")
  log2ratios <- numeric(length(all_amino_acids))
  
  for (aa in all_amino_acids) {
    count_group1 <- sum(sapply(group1_seqs, function(seq) sum(unlist(strsplit(as.character(seq), "")) == aa)))
    count_group2 <- sum(sapply(group2_seqs, function(seq) sum(unlist(strsplit(as.character(seq), "")) == aa)))
    
    freq_group1 <- count_group1 / sum(sapply(group1_seqs, nchar))
    freq_group2 <- count_group2 / sum(sapply(group2_seqs, nchar))
    
    log2ratios[aa] <- log2(freq_group1 / freq_group2)
  }
  
  log2ratio_df <- data.frame(Aminoacid = all_amino_acids, log2ratio = log2ratios)
  return(log2ratio_df)
}
```

```{r loading_data, echo=F}
## genes
# candidates = read.csv(file.path(tumorReactDIR,"TOv3x_5percent_TestisRestrictedGTEx_Translated_Ctypes_log2ratio3xMEANgenes.csv"))
# candidates = merge(candidates, annot %>% select(gene_id, chr), by="gene_id")
# candidates = candidates %>% mutate(coding_noncoding_chr = case_when(gene_type == "protein_coding" & chr == "X" ~ "CT-X",
#                                                            gene_type == "protein_coding" & chr != "X" ~ "CT-nonX",
#                                                            gene_type != "protein_coding" & chr == "X" ~ "Noncoding-X",
#                                                            gene_type != "protein_coding" & chr != "X" ~ "Noncoding-nonX"),
#                                    type = case_when(gene_type == "protein_coding" ~ "CT",
#                                                     TRUE ~ "Noncoding"))
# 
# print(candidates %>% subset(coding_noncoding_chr == "Noncoding-X"))
## ORFs
candidatesORFs = read.csv(file.path(tumorReactDIR,"TOv3x_5percent_TestisRestrictedGTEx_Translated_Ctypes_log2ratio3xMEAN.csv"))
candidatesORFs = merge(candidatesORFs, annot %>% select(gene_id, chr), by="gene_id")
candidatesORFs = candidatesORFs %>% mutate(coding_noncoding_chr = case_when(grepl("ORF", geneORFtype) ~ "altORFs",
                                                                            gene_type == "protein_coding" & chr == "X" & geneORFtype == "protein_coding_canonical" ~ "CT-X",
                                                           gene_type == "protein_coding" & chr != "X" & geneORFtype == "protein_coding_canonical" ~ "CT-nonX",
                                                           gene_type != "protein_coding" & chr == "X" ~ "Noncoding-X",
                                                           gene_type != "protein_coding" & chr != "X" ~ "Noncoding-nonX"),
                                            type = case_when(gene_type == "protein_coding" ~ "CT",
                                                    TRUE ~ "Noncoding"),
                                           altORFs_chr = case_when(grepl("ORF", geneORFtype) & chr == "X" ~ "altORFs-X",
                                                                   grepl("ORF", geneORFtype) & chr != "X" ~ "altORFs-nonX"))
chr_summary = candidatesORFs %>% select(coding_noncoding_chr, ctype, orfID) %>% unique()
table(chr_summary$coding_noncoding_chr, chr_summary$ctype)

## TE
TE = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Multimap_altORFs/Q1_TestisORFs/human/mean_translationEfficiency_testis.csv")
candidatesORFs = merge(TE %>% select(orfID, mean_TE), candidatesORFs, by=c("orfID"))

## CanonicalRatio
canonicalRatio = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/JC_RiboSeq_TPMs/Outputs/with_TranscriptomeReconstruction/Expression/v47_altORFs_MultMap/ribORF.CDS_altORFs.allSamples.tsv", sep="\t")
canonicalRatio$tissue = gsub("_.*","",canonicalRatio$Sample)
canonicalRatio = canonicalRatio %>% group_by(orfID, tissue) %>%
  mutate(mean_canonicalRatio = mean(canonicalRatio))
canonicalRatio = canonicalRatio %>% ungroup() %>% subset(tissue == "testis") %>% select(orfID, mean_canonicalRatio, tissue) %>% unique()

candidatesORFs = merge(canonicalRatio, candidatesORFs, by=c("orfID"), all.y=T)

## GTEx 
GTEx = read.csv("/data/genomics/marta/genomes/GTEx/v10/GTEx_maintissue_gene_median_tpm.csv")
GTEx_candidates = GTEx %>% subset(Name %in% candidatesORFs$gene_id)
candidatesORFs = merge(candidatesORFs, GTEx %>% select(Name, Testis), by.x="gene_id", by.y="Name", how="left")

## evo origin
conservation = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/EvolutionaryOrigin_MMseqs/Clustering/allHuman_matrix_oldestAge.tsv", sep="\t")
candidatesORFs = merge(candidatesORFs, conservation, by=c("orfID", "gene_type", "gene_name"), how="left")
candidatesORFs = candidatesORFs %>% mutate(age_categorical = case_when(oldest_species == "macaca"  ~ "primate-specific",
                                                                 oldest_species == "human"  ~ "humman-specific",
                                                                 oldest_species == "chicken" ~ "conserved - outgroup",
                                                                 oldest_species == "mouse" ~ "mouse",
                                                   TRUE ~ "mammal"))

## thymus expr
thymus_candidates_summary = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/human/quantification_thymus/thymus_summary_TOv3xlog2ratio3xmean.csv")
thymus_candidates_summary = thymus_candidates_summary %>% select(gene_id, median) %>% unique()
names(thymus_candidates_summary)[2] = "median_mTEC"
candidatesORFs = merge(candidatesORFs, thymus_candidates_summary, by=c("gene_id"), how="left")

write.csv(candidatesORFs, file.path(tumorReactDIR,"TSTR_candidatesORFs_fullcharacterized.csv"))
```

## CHROMOSOME LOCATION

```{r chr, echo=F}
gtf_file = "/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/v47/human/newReference_Resconstructed/gencode.v47.gffcompare.TestisLiverBrain.annotation.sorted.1transcript.sorted.gtf"
gtf_data = import(gtf_file, format = "gtf")

GRanges_GTF = as(gtf_data, "GRanges")
GRanges_GTF$gene_id = gsub("\\..*","",GRanges_GTF$gene_id)

GRanges_GTF_tumorReact = GRanges_GTF %>% subset(gene_id %in% candidatesORFs$gene_id) %>% subset(type == "transcript") 
GRanges_GTF_tumorReact$gene_type[is.na(GRanges_GTF_tumorReact$gene_type)] <- "novel"

GRanges_GTF_tumorReact_CODING = GRanges_GTF_tumorReact %>% subset(gene_type == "protein_coding")
length(GRanges_GTF_tumorReact_CODING$gene_id)


GRanges_GTF_tumorReact_NONCODING = GRanges_GTF_tumorReact %>% subset(gene_type != "protein_coding")
mcols(GRanges_GTF_tumorReact_NONCODING)$gene_name <- ifelse(
  is.na(mcols(GRanges_GTF_tumorReact_NONCODING)$gene_name),
  mcols(GRanges_GTF_tumorReact_NONCODING)$gene_id,
  mcols(GRanges_GTF_tumorReact_NONCODING)$gene_name
)
length(GRanges_GTF_tumorReact_NONCODING$gene_id)

# png(file.path(plots_wd,"/PNG/TOv3xlog2ratio3xMEAN_location_chr.png"), height=9.26, width=15.20, units = "in", res=400)
kp <- plotKaryotype(genome="hg38")
# Plot the coding genes with lollipop markers
kpSegments(kp, data=GRanges_GTF_tumorReact_CODING,
           y0=0, y1=0.5, col="#cd4f38") # Add stems
kpPoints(kp, data=GRanges_GTF_tumorReact_CODING,
         y=0.5, col="#cd4f38", pch=19, cex=0.8) # Add dots

# Plot the non-coding genes with lollipop markers
kpSegments(kp, data=GRanges_GTF_tumorReact_NONCODING,
           y0=0, y1=0.5, col="#ead890") # Add stems
kpPoints(kp, data=GRanges_GTF_tumorReact_NONCODING,
         y=0.5, col="#ead890", pch=19, cex=0.8) # Add dots
# Add legend
legend("bottomright",                    # Position
       legend=c("Coding Genes", "Non-coding Genes"),  # Labels
       col=c("#cd4f38", "#ead890"),           # Colors matching the plot
       pch=19,                         # Point style
       pt.cex=0.6,                     # Point size to match the plot
       title="Gene Type")              # Legend title
# dev.off()

## which are those noncoding-X?
candidatesORFs %>% subset(coding_noncoding_chr == "Noncoding-X") %>% select(gene_name, coding_noncoding_chr) %>% unique()

## removed from candidates
candidatesORFs = candidatesORFs %>% subset(coding_noncoding_chr != "Noncoding-X")
```

```{r howmany_per_ctype, echo=F}
candidatesORFs %>% select(gene_name, ctype, coding_noncoding_chr) %>% 
  subset(coding_noncoding_chr != "altORFs") %>% unique() %>%
  mutate(ctype_CTcontent = case_when(ctype %in% c("BLCA","LUSC","LIHC","LUAD") ~ "CT rich",
                                     ctype %in% c("BRCA","PRAD") ~ "CT medium",
                                     ctype %in% c("COAD", "KIRC") ~ "CT poor")) %>%
  ggplot(aes(x=ctype, y=..count.., fill=coding_noncoding_chr)) +
  geom_bar(position = position_dodge(preserve = "single")) +
  scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
  labs(x="Cancer type",
       y="Number of TSTR",
       title="TSTR per cancer type",
       fill="") +
  theme_minimal() +
  facet_grid(~ ctype_CTcontent, scales="free_x", space="free")
ggsave(file.path(plots_wd,"PNG/TSTR_per_ctype.png"), height=4.94, width=6.85)
```

## COMPARISONS AT GENE LEVEL

```{r length, echo=F}
################ -- NO SENSE, IT WAS NOT GENE LENGTH -- ##################
# ggplot(candidatesORFs %>% 
#          # subset(!grepl("ORF", geneORFtype)) %>% 
#          select(gene_id, gene_name, geneORFtype, length, coding_noncoding_chr, type) %>% unique(), aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")), y=length, fill=coding_noncoding_chr)) +
#   geom_boxplot() +
#   geom_jitter() +
#   stat_compare_means(label="p.format", comparisons = list(c("CT-X","CT-nonX"), 
#                                                           c("CT-X","Noncoding-nonX"), 
#                                                           c("CT-nonX","Noncoding-nonX"), 
#                                                           c("CT-nonX","altORFs"),
#                                                           c("CT-X","altORFs"),
#                                                           c("Noncoding-nonX","altORFs"))) +
#   scale_y_continuous(trans="log10") +
#   scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
#   labs(y="Length (nt)",
#        x="",
#        title="Length | Gene level") +
#   theme_minimal() 
# ggsave(file.path(plots_wd,"PNG/length_geneORFtype.png"))
# 
# ## altORFs
# ggplot(candidatesORFs %>% 
#          subset(grepl("ORF", geneORFtype)) %>% select(gene_id, gene_name, geneORFtype, length, altORFs_chr, type) %>% unique(), aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=length, fill=altORFs_chr)) +
#   geom_boxplot() +
#   geom_jitter() +
#       scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
#   scale_y_continuous(trans="log10") +
#   labs(y="Length (nt)",
#        x="",
#        title="Length | Gene level | Alternative ORFs") +
#   theme_minimal() +
#   theme(axis.text.x=element_text(angle=45)) +
#   facet_wrap(~ geneORFtype, ncol=4, scales="free_x") +
#    stat_compare_means(label="p.format")
# ggsave(file.path(plots_wd,"PNG/length_altORFs.png"))
```

```{r GTEx_expression, echo=F}
candidatesORFs$logTPM_Testis = log(candidatesORFs$Testis)

ggplot(candidatesORFs %>% 
         # subset(!grepl("ORF", geneORFtype)) %>% 
         select(gene_id, gene_name, geneORFtype, logTPM_Testis, coding_noncoding_chr, type) %>% unique(), aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")), y=logTPM_Testis, fill=coding_noncoding_chr)) +
  geom_boxplot() +
  geom_jitter() +
  scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
  stat_compare_means(label="p.format", comparisons = list(c("CT-X","CT-nonX"), 
                                                          c("CT-X","Noncoding-nonX"), 
                                                          c("CT-nonX","Noncoding-nonX"), 
                                                          c("CT-nonX","altORFs"),
                                                          c("CT-X","altORFs"),
                                                          c("Noncoding-nonX","altORFs"))) +
  labs(y="log(Median TPM)",
       x="",
       title="Expression in testis (GTEx)") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/logTPMTestis.png"))

## altORFs
ggplot(candidatesORFs %>% subset(grepl("ORF", geneORFtype)) %>% select(gene_id, gene_name, geneORFtype, logTPM_Testis, altORFs_chr, type) %>% unique(), aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=logTPM_Testis, fill=altORFs_chr)) +
  geom_boxplot() +
  geom_jitter() +
      scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
  labs(y="log(Median TPM)",
       x="",
       title="Expression in testis (GTEx)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45)) +
  facet_wrap(~ geneORFtype, ncol=4, scales="free_x") +
  stat_compare_means(label="p.format")
ggsave(file.path(plots_wd,"PNG/logTPMTestis_altORFs.png"))

```

```{r cancertypes_shared, echo=F}
# View(candidatesORFs %>% select(gene_name, ctype, coding_noncoding_chr, type, percentage_num_patients_overexpr))
# 
# View(candidatesORFs %>% select(gene_name, ctype, coding_noncoding_chr, type) %>% unique() %>%
#   group_by(gene_name, coding_noncoding_chr, type) %>% count())

## to upsets, one for X (colored by coding noncoding) & another one for nonX (colored by coding noncoding)
data_to_upset = candidatesORFs %>% subset(coding_noncoding_chr != "altORFs") %>% select(gene_name, ctype, coding_noncoding_chr, type) %>% unique()
data_to_upset$presence = 1
########
# to_upset = data_to_upset %>% pivot_wider(names_from = "ctype", values_from = "presence")
# to_upset[is.na(to_upset)] <- 0
# to_upset = to_upset %>% select(-c(coding_noncoding_chr, type))
# 
# ## convert to matrix
# matrix_to_upset = as.matrix(to_upset)
# rownames(matrix_to_upset) = matrix_to_upset[,1]
# matrix_to_upset = matrix_to_upset[,-1]
# matrix_to_upset <- as.data.frame(matrix_to_upset)
# # Convert the matrix into a format that UpSetR can process
# upset_data_num <- as.data.frame(lapply(matrix_to_upset, as.numeric))
# library(UpSetR)
# 
# UpSetR::upset(upset_data_num, sets=colnames(upset_data_num), order.by = "freq")
##########

# Prepare the data for ComplexUpset
upset_data <- data_to_upset %>%
  pivot_wider(names_from = ctype, values_from = presence, values_fill = 0) %>%
  mutate(coding_noncoding_chr = data_to_upset$coding_noncoding_chr[match(gene_name, data_to_upset$gene_name)])

upset_data_toplot = upset_data %>% select(-gene_name, coding_noncoding_chr, type)

# Generate the upset plot with annotations
png(filename = file.path(plots_wd,"PNG/upset_TSTR_chr.png"), width=11.53, height=7.45, res=400, units="in")
ComplexUpset::upset(
  upset_data,
  intersect = colnames(upset_data)[4:ncol(upset_data)], # Use all ctype columns as sets
  annotations = list("Coding Type" = (
    ggplot(mapping = aes(fill=coding_noncoding_chr)) +
      geom_bar(stat="count", position="fill") +
      scale_y_continuous(labels=scales::percent_format()) +
      scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31")) +
        ylab("Coding Type")
)),     width_ratio=0.1
)
dev.off()
```


```{r upset_CTx, echo=F}
upset_data_CTX <- upset_data %>%
  subset(coding_noncoding_chr == "CT-X")

png(filename = file.path(plots_wd,"PNG/upset_TSTR_CTX.png"), width=11.53, height=7.45, res=400, units="in")
ComplexUpset::upset(
  upset_data_CTX,
  intersect = colnames(upset_data)[4:ncol(upset_data)], # Use all ctype columns as sets
  base_annotations=list(
          'Intersection size'=intersection_size(
              counts=T,
              fill="#833437"
          )
      ),
    width_ratio=0.1) +
  ggtitle("CT-X")
dev.off()
```

```{r upset_CTnonx, echo=F}
upset_data_CTnonX <- upset_data %>%
  subset(coding_noncoding_chr == "CT-nonX")

png(filename = file.path(plots_wd,"PNG/upset_TSTR_CTnonX.png"), width=11.53, height=7.45, res=400, units="in")
ComplexUpset::upset(
  upset_data_CTnonX,
  intersect = colnames(upset_data)[4:ncol(upset_data)], # Use all ctype columns as sets
  base_annotations=list(
          'Intersection size'=intersection_size(
              counts=T,
              fill="#ead890"
          )
      ),
    width_ratio=0.1) +
  ggtitle("CT-nonX")
dev.off()
```

```{r upset_NoncodingNonX, echo=F}
upset_data_NoncodingnonX <- upset_data %>%
  subset(coding_noncoding_chr == "Noncoding-nonX")

png(filename = file.path(plots_wd,"PNG/upset_TSTR_NoncodingNonX.png"), width=11.53, height=7.45, res=400, units="in")
ComplexUpset::upset(
  upset_data_NoncodingnonX,
  intersect = colnames(upset_data)[4:ncol(upset_data)], # Use all ctype columns as sets
  base_annotations=list(
          'Intersection size'=intersection_size(
              counts=T,
              fill="#646c31"
          )
      ),
    width_ratio=0.1) +
  ggtitle("Noncoding-nonX")
dev.off()
```

```{r thymus, echo=F}
ggplot(candidatesORFs %>% 
                # subset(!grepl("ORF", geneORFtype)) %>% 
         select(gene_id, gene_name, geneORFtype, median_mTEC, coding_noncoding_chr, type) %>% unique(), aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")),  y=log(median_mTEC + 0.000001), fill=coding_noncoding_chr)) +
  geom_boxplot() +
  geom_jitter() +
  scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
  stat_compare_means(label="p.format", comparisons = list(c("CT-X","CT-nonX"), 
                                                          c("CT-X","Noncoding-nonX"), 
                                                          c("CT-nonX","Noncoding-nonX"), 
                                                          c("CT-nonX","altORFs"),
                                                          c("CT-X","altORFs"),
                                                          c("Noncoding-nonX","altORFs"))) +
  labs(y="Median TPM",
       x="",
       title="Median expression in thymus") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/logTPM_thymus.png"))
```

## COMPARISONS AT ORF LEVEL

```{r length_ORF, echo=F}
ggplot(candidatesORFs %>% select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
         # subset(!grepl("ORF", geneORFtype)) %>% 
         unique(), aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")), y=length_aa, fill=coding_noncoding_chr)) +
  geom_boxplot() +
  geom_jitter() +
  stat_compare_means(label="p.format", comparisons = list(c("CT-X","CT-nonX"), 
                                                          c("CT-X","Noncoding-nonX"), 
                                                          c("CT-nonX","Noncoding-nonX"), 
                                                          c("CT-nonX","altORFs"),
                                                          c("CT-X","altORFs"),
                                                          c("Noncoding-nonX","altORFs"))) +
  scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
  labs(y="Length (aa)",
       x="",
       title="Length | ORF level") +
  scale_y_continuous(trans="log10") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/lengthORF_geneORFtype.png"))

## only altORFs
ggplot(candidatesORFs %>% 
         select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
         subset(grepl("ORF", geneORFtype)) %>% 
         unique(), 
       aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=length_aa, fill=altORFs_chr)) +
  geom_boxplot() +
  geom_jitter() +
      scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
  labs(y="Length (aa)",
       x="",
       title="Length | ORF level | alternative ORFs") +
  scale_y_continuous(trans="log10") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=45)) +
  facet_wrap(~ geneORFtype, ncol=4, scales="free_x") +
    stat_compare_means(label="p.format")
ggsave(file.path(plots_wd,"PNG/lengthORF_altORFs.png"))
```

```{r TE_ORF, echo=F}
ggplot(candidatesORFs %>% 
         select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
         # subset(!grepl("ORF", geneORFtype)) %>% 
         unique(), aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")), y=mean_TE, fill=coding_noncoding_chr)) +
  geom_boxplot() +
  geom_jitter() +
  stat_compare_means(label="p.format", comparisons = list(c("CT-X","CT-nonX"), 
                                                          c("CT-X","Noncoding-nonX"), 
                                                          c("CT-nonX","Noncoding-nonX"), 
                                                          c("CT-nonX","altORFs"),
                                                          c("CT-X","altORFs"),
                                                          c("Noncoding-nonX","altORFs"))) +
  scale_fill_manual(values=c("CT-X" = "#833437", "CT-nonX" = "#ead890", "Noncoding-nonX" = "#646c31", "altORFs" = "#728FCE")) +
  labs(y="Mean Translation Efficiency in testis",
       x="",
       title="Translation Efficiency | ORF level") +
  scale_y_continuous(trans="log10") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/TE_geneORFtype.png"))

## altORFs
ggplot(candidatesORFs %>% 
         select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
         subset(grepl("ORF", geneORFtype)) %>% 
         unique(), aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=mean_TE, fill=altORFs_chr)) +
  geom_boxplot() +
      scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
  labs(y="Mean Translation Efficiency in testis",
       x="",
       title="Translation Efficiency | ORF level | alternative ORFs") +
  scale_y_continuous(trans="log10") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=45)) +
  facet_wrap(~ geneORFtype, ncol=4, scales="free_x")
ggsave(file.path(plots_wd,"PNG/TE_altORFs.png"))

```

```{r canonicalRatio, echo=F}
## altORFs
# ggplot(candidatesORFs %>% 
#          select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
#          subset(grepl("ORF", geneORFtype)) %>% 
#          unique(), aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=mean_canonicalRatio, fill=altORFs_chr)) +
#   geom_violin() +
#   geom_boxplot(fill=NA, width=.2) +
#   geom_jitter() +
#       scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
#   labs(y="Mean Translation Efficiency with respect to the CDS",
#        x="",
#        title="Translation Efficiency with respect to the CDS | ORF level | alternative ORFs") +
#   theme_minimal() +
#   facet_wrap(~ geneORFtype, scales="free_x")
# ggsave(file.path(plots_wd,"PNG/canonicalRatio_altORFs.png"))

ggplot(candidatesORFs %>% 
         select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
         subset(grepl("ORF", geneORFtype)) %>% 
         unique(), aes(x=factor(altORFs_chr, levels=c("altORFs-X","altORFs-nonX")), y=mean_canonicalRatio, fill=altORFs_chr)) +
  geom_violin() +
  geom_boxplot(fill=NA, width=.2) +
  geom_jitter() +
      scale_fill_manual(values=c("altORFs-X" = "#833437", "altORFs-nonX" = "#ead890")) +
  labs(y="Mean Translation Efficiency with respect to the CDS",
       x="",
       title="Translation Efficiency with respect to the CDS | ORF level | alternative ORFs") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/canonicalRatio_altORFs.png"))
```

```{r evo_ORF, echo=F}
candidatesORFs %>% 
  select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
  # subset(!grepl("ORF", geneORFtype)) %>% 
  unique() %>% 
  group_by(coding_noncoding_chr, age_categorical, type) %>%
ggplot(., aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","altORFs")), fill=age_categorical)) +
  geom_bar(position="dodge") +
  labs(y="Number of ORFs",
       x="",
       title="ORF conservation") +
  scale_y_continuous(trans="log10") +
  theme_minimal() 
ggsave(file.path(plots_wd,"PNG/Evo_geneORFtype.png"))

## altORFs --> all are human-specific
# candidatesORFs %>% 
#   select(-c(percentage_num_patients_overexpr, num_patients_overexpr, ctype)) %>% 
#   subset(grepl("ORF", geneORFtype)) %>% 
#   unique() %>% 
#   group_by(coding_noncoding_chr, age_categorical, type) %>%
# ggplot(., aes(x=factor(coding_noncoding_chr, levels=c("CT-X","CT-nonX","Noncoding-nonX","Noncoding-X")), fill=age_categorical)) +
#   geom_bar(position="dodge") +
#   labs(y="Number of ORFs",
#        x="",
#        title="ORF conservation | alternative ORFs") +
#   scale_y_continuous(trans="log10") +
#   theme_minimal() +
#   facet_wrap(~ geneORFtype, ncol=4, scales="free_x")
```

```{r aa_noaltrORFs, echo=F}
# Calculate amino acid frequency normalized by sequence length
candidatesORFs$ORFpep = gsub("\\*","",candidatesORFs$ORFpep)

########### no alt ORFs - CT-X, CT-nonX, Noncoding-nonX
amino_acid_frequencies <- candidatesORFs %>%
  subset(!grepl("ORF", geneORFtype)) %>%
  # Group by coding_noncoding_chr
  group_by(coding_noncoding_chr) %>%
  # Process each group
  summarise(
    amino_freq = list(
      ORFpep %>%
        strsplit("") %>%
        # Flatten the list of sequences into a single character vector
        unlist() %>%
        # Count occurrences of each amino acid
        table() %>%
        # Convert to a named numeric vector
        prop.table() %>%
        as.data.frame()
    )
  ) %>%
  unnest(amino_freq)
names(amino_acid_frequencies) = c("coding_noncoding_chr", "aminoacid","frequency")

# Remove Noncoding-X
amino_acid_frequencies = amino_acid_frequencies %>% subset(coding_noncoding_chr != "Noncoding-X")

to_plot = amino_acid_frequencies %>% pivot_wider(names_from="aminoacid", values_from="frequency")
to_plot = as.data.frame(to_plot)
rownames(to_plot) = to_plot$coding_noncoding_chr
to_plot$coding_noncoding_chr = NULL

to_plot <- rbind(rep(0.12,20) , rep(0,20) , to_plot)
colors_border=c("#833437", "#ead890" ,"#646c31" )

png(file.path(plots_wd,"PNG/AA_radarchart_geneORFtype_noaltORFs.png"))
radarchart(to_plot, maxmin = T,
           axistype = 0, plwd=2 , plty=1,
           pcol=colors_border, title="Aminoacids enrichment in ORFs")
legend(x=-1.5, y=-0.8, legend = rownames(to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1, pt.cex=1.5)
dev.off()
# 
# 
# hph=c("A","V","L","I","M","F","Y","W")
# polar=c("S","T","N","Q")
# positively_charged=c("R","H","K")
# # negatively_charged=c("D","E")
# # special_cases=c("C","G","P")
# 
# ### hidrophobic
# hph_to_plot = to_plot %>% select(hph)
# radarchart(hph_to_plot, maxmin = T,
#            axistype = 0, plwd=2 , plty=1,
#            pcol=colors_border, title="Hidrophobic aminoacids enrichment in ORFs")
# legend(x=1.7, y=1, legend = rownames(hph_to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1.2, pt.cex=3)
# 
# ### polar
# polar_to_plot = to_plot %>% select(polar)
# radarchart(polar_to_plot, maxmin = T,
#            axistype = 0, plwd=2 , plty=1,
#            pcol=colors_border, title="Polar aminoacids enrichment in ORFs")
# legend(x=1.7, y=1, legend = rownames(polar_to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1.2, pt.cex=3)
# 
# ### positive
# pos_to_plot = to_plot %>% select(positively_charged)
# radarchart(pos_to_plot, maxmin = T,
#            axistype = 0, plwd=2 , plty=1,
#            pcol=colors_border, title="Positively charged aminoacids enrichment in ORFs")
# legend(x=1.7, y=1, legend = rownames(pos_to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1.2, pt.cex=3)
# 
### negative
# neg_to_plot = to_plot %>% select(negatively_charged)
# radarchart(neg_to_plot, maxmin = T,
#            axistype = 0, plwd=2 , plty=1,
#            pcol=colors_border, title="Negatively charged aminoacids enrichment in ORFs")
# legend(x=1.7, y=1, legend = rownames(neg_to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1.2, pt.cex=3)

```

```{r aa_altrORFs, echo=F}
########### alt ORFs, CT-X, CT-nonX, Noncoding-nonX
amino_acid_frequencies_ORFchr <- candidatesORFs %>%
  mutate(ORFtype_chr = case_when(grepl("ORF",geneORFtype) ~ "altORF",
                                 TRUE ~ coding_noncoding_chr)) %>% 
  # Group by coding_noncoding_chr
  group_by(ORFtype_chr) %>%
  # Process each group
  summarise(
    amino_freq = list(
      ORFpep %>%
        strsplit("") %>%
        # Flatten the list of sequences into a single character vector
        unlist() %>%
        # Count occurrences of each amino acid
        table() %>%
        # Convert to a named numeric vector
        prop.table() %>%
        as.data.frame()
    )
  ) %>%
  unnest(amino_freq)
names(amino_acid_frequencies_ORFchr) = c("ORFtype_chr", "aminoacid","frequency")

# Remove Noncoding-X
amino_acid_frequencies_ORFchr = amino_acid_frequencies_ORFchr %>% subset(ORFtype_chr != "Noncoding-X")

to_plot = amino_acid_frequencies_ORFchr %>% pivot_wider(names_from="aminoacid", values_from="frequency")
to_plot = as.data.frame(to_plot)
rownames(to_plot) = to_plot$ORFtype_chr
to_plot$ORFtype_chr = NULL

to_plot <- rbind(rep(0.12,20) , rep(0,20) , to_plot)
colors_border=c("#833437", "#ead890" ,"#646c31","#728FCE")

png(file.path(plots_wd,"PNG/AA_radarchart_ORFtype_withaltORFs.png"))
radarchart(to_plot, maxmin = T,
           axistype = 0, plwd=2 , plty=1,
           pcol=colors_border, title="Aminoacids enrichment in ORFs")
legend(x=-1.5, y=-0.8, legend = rownames(to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1, pt.cex=1.5)
dev.off()
```

```{r aa_3, echo=F}
########### alt ORFs, CT-X, CT-nonX, Noncoding-nonX
amino_acid_frequencies_ORFs <- candidatesORFs %>%
  mutate("ORFNature" = case_when(grepl("ORF",geneORFtype) ~ "altORF",
                                 grepl("Noncoding", coding_noncoding_chr) ~ "Noncoding",
                                 TRUE ~ "Protein-Coding")) %>% 
  # Group by coding_noncoding_chr
  group_by(ORFNature) %>%
  # Process each group
  summarise(
    amino_freq = list(
      ORFpep %>%
        strsplit("") %>%
        # Flatten the list of sequences into a single character vector
        unlist() %>%
        # Count occurrences of each amino acid
        table() %>%
        # Convert to a named numeric vector
        prop.table() %>%
        as.data.frame()
    )
  ) %>%
  unnest(amino_freq)
names(amino_acid_frequencies_ORFs) = c("ORFNature", "aminoacid","frequency")

to_plot = amino_acid_frequencies_ORFs %>% pivot_wider(names_from="aminoacid", values_from="frequency")
to_plot = as.data.frame(to_plot)
rownames(to_plot) = to_plot$ORFNature
to_plot$ORFNature = NULL

to_plot <- rbind(rep(0.12,20) , rep(0,20) , to_plot)
colors_border=c("#ead890", "#cd4f38" ,"#728FCE")

png(file.path(plots_wd,"PNG/AA_radarchart_ORFNature.png"))
radarchart(to_plot, maxmin = T,
           axistype = 0, plwd=2 , plty=1,
           pcol=colors_border, title="Aminoacids enrichment in ORFs")
legend(x=-1.5, y=-0.8, legend = rownames(to_plot[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1, pt.cex=1.5)
dev.off()

## ONLY NONCODING, are they similar?
to_plot_ncORFs = to_plot[-4,]
colors_border=c("#ead890","#728FCE")

png(file.path(plots_wd,"PNG/AA_radarchart_ncORFs.png"))
radarchart(to_plot_ncORFs, maxmin = T,
           axistype = 0, plwd=2 , plty=1,
           pcol=colors_border, title="Aminoacids enrichment in ncORFs")
legend(x=-1.5, y=-0.8, legend = rownames(to_plot_ncORFs[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey", cex=1, pt.cex=1.5)
dev.off()
```

