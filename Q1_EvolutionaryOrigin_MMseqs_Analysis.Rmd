---
title: "MMSeqs2 Conservation"
author: "Marta Espinosa"
date: "2024-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(purrr)
library(ggvenn)
library(ggpubr)
library(ggside)
library(bioseq)
library(ggbeeswarm)
library(ggbreak)
library(pheatmap)

annot = read.csv("/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/human/newReference_Resconstructed/1transcript_1gene.reconstructed.csv")
# names(gene_transcript) = c("gene_id"gene_type"gene_name")
# gene_transcript$gene_id = gsub("\\..*"gene_transcript$gene_id)

plots_wd = "/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q1_EvolutionaryOrigin/human/plots"
save_wd = "/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q1_EvolutionaryOrigin/human"

species=c("mouse","macaca","platypus","chicken","opossum")

evoDir = "/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/EvolutionaryOrigin_MMseqs"

mycolors=list("gene_type" = c("protein_coding"="#CC79A7",
                               "lncRNA" = "#009E73",
                               "processed_pseudogene" = "#0090B2",
                               "novel" = "#E69F00"))
```

## Evolutionary Origin

For human, only those that are translated in Testis:

`/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q1_TestisORFs/human/ribORF_humanTestis_in1.fa`

For the species, everything that is translated

`/users/genomics/marta/TestisProject_SaraRazquin/with_TranscriptomeReconstruction/*/RiboSeq/RiboQC_RiboNovel*/RibORF/*_repre.valid.pred.pvalue.parameters.PROTEIN.noredunant.fa`

### Non-coding Conserved

```{r nc_conserved, echo=F}
nc_conserved = read.csv(file.path(evoDir,"Clustering/noncodingHuman_Conserved_matrix.tsv"), sep="\t")
nc_conserved_ordered = nc_conserved[order(nc_conserved$sum, decreasing = TRUE), ] 

matrix = nc_conserved_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = nc_conserved$orfID

## row annotation - gene_type
row_annotation = nc_conserved_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ncORFs in human")
```

### Canonical Conserved

```{r cds_conserved, echo=F}
cds_conserved = read.csv(file.path(evoDir,"Clustering/canonicalHuman_Conserved_matrix.tsv"), sep="\t")
cds_conserved_ordered = cds_conserved[order(cds_conserved$sum, decreasing = TRUE), ] 

matrix = cds_conserved_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = cds_conserved$orfID

## row annotation - gene_type
row_annotation = cds_conserved_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of CDS in human")
```

## Both canonical and ncORFs conserved

```{r merged, echo=F}
conserved = rbind(cds_conserved, nc_conserved)
conserved_ordered = conserved[order(conserved$sum, decreasing = TRUE), ] 

matrix = conserved_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = conserved$orfID

## row annotation - gene_type
row_annotation = conserved_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ORFs in human")
```

## How does it look like for TOv2x - 5%?

```{r TOv2x_5percent, echo=F}
TOv3x = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q4_TestisRestricted_TumorSpecific/human/TOv2xdata_long_5percent.csv")

conserved_ordered_TOv3x = conserved_ordered %>% subset(gene_name %in% TOv3x$gene_name)

matrix_TOv3x = conserved_ordered_TOv3x %>% select(macaca, mouse, opossum, platypus, chicken)
matrix_TOv3x = apply(matrix_TOv3x, 2, as.numeric)
matrix_TOv3x = as.matrix(matrix_TOv3x)
rownames(matrix_TOv3x) = conserved_ordered_TOv3x$orfID

pheatmap(matrix_TOv3x, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ORFs in human | TumorOverexpressed 2x in at least 5% of the patients in some ctype")
```


## How does it look like for TOv3x - 10%?

```{r TOv3x_10percent, echo=F}
TOv3x_10percent = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q4_TestisRestricted_TumorSpecific/human/TOv3xdata_long_10percent.csv")

conserved_ordered_TOv3x = conserved_ordered %>% subset(gene_name %in% TOv3x_10percent$gene_name)

matrix_TOv3x = conserved_ordered_TOv3x %>% select(macaca, mouse, opossum, platypus, chicken)
matrix_TOv3x = apply(matrix_TOv3x, 2, as.numeric)
matrix_TOv3x = as.matrix(matrix_TOv3x)
rownames(matrix_TOv3x) = conserved_ordered_TOv3x$orfID

pheatmap(matrix_TOv3x, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ORFs in human | TumorOverexpressed 3x in at least 10% of the patients in some ctype")
```

## Not only conserved but all, also non-conserved

```{r all_noncoding, echo=F}
all_nc = read.csv(file.path(evoDir,"Clustering/noncodingHuman_matrix.tsv"), sep="\t")
all_nc_ordered = all_nc[order(all_nc$sum, decreasing = TRUE), ] 

matrix = all_nc_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = all_nc$orfID

## row annotation - gene_type
row_annotation = all_nc_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Evolutionary Origin of ncORFs in human")
```

```{r all_canonical, echo=F}
all_cds = read.csv(file.path(evoDir,"Clustering/canonicalHuman_matrix.tsv"), sep="\t")
all_cds_ordered = all_cds[order(all_cds$sum, decreasing = TRUE), ] 

matrix = all_cds_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = all_cds$orfID

## row annotation - gene_type
row_annotation = all_cds_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Evolutionary Origin of CDS in human")
```

```{r merged_all, echo=F}
merged = rbind(all_nc, all_cds)

merged_ordered = merged[order(merged$sum, decreasing = TRUE), ] 

matrix = merged_ordered %>% select(macaca, mouse, opossum, platypus, chicken)
matrix = apply(matrix, 2, as.numeric)
matrix = as.matrix(matrix)
rownames(matrix) = merged_ordered$orfID

## row annotation - gene_type
row_annotation = merged_ordered %>% select(orfID, gene_type)
rownames(row_annotation) = row_annotation$orfID
row_annotation$orfID = NULL

pheatmap(matrix, cluster_rows=F, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Evolutionary Origin of CDS and ncORFs in human")
```


## How does it look like for TOv2x - 5%?

```{r TOv2x_5percent_all, echo=F}
TOv2x = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q4_TestisRestricted_TumorSpecific/human/TOv2xdata_long_5percent.csv")

merged_ordered_TOv2x = merged_ordered %>% subset(gene_name %in% TOv2x$gene_name)

matrix_TOv2x = merged_ordered_TOv2x %>% select(macaca, mouse, opossum, platypus, chicken)
matrix_TOv2x = apply(matrix_TOv2x, 2, as.numeric)
matrix_TOv2x = as.matrix(matrix_TOv2x)
rownames(matrix_TOv2x) = merged_ordered_TOv2x$orfID

pheatmap(matrix_TOv2x, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ORFs and CDSs in human\nTumorOverexpressed 2x in at least 5% of the patients in some ctype")
```


## How does it look like for TOv3x - 10%?

```{r TOv3x_10percent_all, echo=F}
TOv3x_10percent = read.csv("/projects_eg/projects/marta/TestisRestricted_Microproteins_TSA/with_TranscriptomeReconstruction/Q4_TestisRestricted_TumorSpecific/human/TOv3xdata_long_10percent.csv")

merged_ordered_TOv3x = merged_ordered %>% subset(gene_name %in% TOv3x_10percent$gene_name)

matrix_TOv3x = merged_ordered_TOv3x %>% select(macaca, mouse, opossum, platypus, chicken)
matrix_TOv3x = apply(matrix_TOv3x, 2, as.numeric)
matrix_TOv3x = as.matrix(matrix_TOv3x)
rownames(matrix_TOv3x) = merged_ordered_TOv3x$orfID

pheatmap(matrix_TOv3x, cluster_rows=FALSE, cluster_cols=FALSE,
         annotation_names_col = FALSE, 
         annotation_names_row = FALSE,
         show_colnames = TRUE,
         show_rownames= FALSE,
         annotation_row = row_annotation,
         annotation_colors = mycolors,  # Custom colors
         color = colorRampPalette(c("lightyellow", "#F57F17"))(50),
         fontsize = 6,
         main="Conservation of ORFs and CDs in human\nTumorOverexpressed 3x in at least 10% of the patients in some ctype")
```
